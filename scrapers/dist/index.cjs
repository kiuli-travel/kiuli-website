#!/usr/bin/env node
(()=>{var e={297:e=>{"use strict";e.exports=require("@sparticuz/chromium")},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")},423:e=>{"use strict";e.exports=require("puppeteer")},397:e=>{"use strict";e.exports=require("puppeteer-core")},127:(e,r,t)=>{e=t.nmd(e);const a=process.env.VERCEL==="1"||process.env.AWS_LAMBDA_FUNCTION_NAME;let s;let i;if(a){s=t(397);i=t(297)}else{s=t(423)}const n=t(896);const o=t(928);const l={reset:"[0m",bright:"[1m",red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",cyan:"[36m"};function log(e,r=l.reset){console.log(`${r}${e}${l.reset}`)}function parseItrvlUrl(e){try{const r=new URL(e);let t=null;let a=null;t=r.searchParams.get("accessKey");a=r.searchParams.get("itineraryId");if(!t||!a){const e=r.pathname.split("/").filter((e=>e.length>0));const s=e.indexOf("portal");if(s!==-1&&e.length>=s+3){t=e[s+1];a=e[s+2]}}if(!t){throw new Error("accessKey not found in URL (tried query params and path)")}if(!a){throw new Error("itineraryId not found in URL (tried query params and path)")}return{accessKey:t,itineraryId:a,baseUrl:`${r.protocol}//${r.host}`}}catch(e){throw new Error(`Failed to parse iTrvl URL: ${e.message}`)}}async function scrapeItrvl(e){log("\n"+"=".repeat(60),l.bright);log("  iTrvl API Scraper - Phase 2",l.bright);log("=".repeat(60),l.bright);log("\n[1/5] Parsing iTrvl URL...",l.blue);let r;try{r=parseItrvlUrl(e);log(`  âœ“ Access Key: ${r.accessKey}`,l.green);log(`  âœ“ Itinerary ID: ${r.itineraryId}`,l.green);log(`  âœ“ Base URL: ${r.baseUrl}`,l.green)}catch(e){log(`  âœ— ${e.message}`,l.red);process.exit(1)}let t=null;let c=null;log("\n[2/5] Launching headless browser...",l.blue);let p;try{if(a){p=await s.launch({args:i.args,defaultViewport:i.defaultViewport,executablePath:await i.executablePath(),headless:i.headless})}else{p=await s.launch({headless:true,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu"]})}log("  âœ“ Browser launched successfully",l.green)}catch(e){log(`  âœ— Failed to launch browser: ${e.message}`,l.red);process.exit(1)}try{const s=await p.newPage();await s.setViewport({width:1920,height:1080});log("\n[3/5] Setting up API interception...",l.blue);await s.setRequestInterception(true);s.on("response",(async e=>{const r=e.url();try{if(r.includes("/api/Itineraries")&&!r.includes("/api/Itineraries/")){log("  â†’ Captured: /api/Itineraries (pricing data)",l.cyan);const r=await e.json();t=r}if(r.includes("/api/PresentationEdits/renderDataClient")){log("  â†’ Captured: /api/PresentationEdits/renderDataClient (itinerary data)",l.cyan);const r=await e.json();c=r}}catch(e){}}));s.on("request",(e=>{e.continue()}));log("  âœ“ API interception configured",l.green);log("\n[4/5] Loading iTrvl portal page...",l.blue);log(`  â†’ Navigating to: ${e}`,l.yellow);try{await s.goto(e,{waitUntil:"networkidle2",timeout:6e4});log("  âœ“ Page loaded successfully",l.green)}catch(e){log(`  âœ— Failed to load page: ${e.message}`,l.red);throw e}log("  â†’ Waiting for all API responses...",l.yellow);await new Promise((e=>setTimeout(e,3e3)));if(!t){throw new Error("Failed to capture /api/Itineraries response")}if(!c){throw new Error("Failed to capture /api/PresentationEdits/renderDataClient response")}log("  âœ“ All required API responses captured",l.green);log("\n[5/5] Processing and merging data...",l.blue);const i=mergeItineraryData(t,c,r);log("  âœ“ Data processed successfully",l.green);log(`  â†’ Itinerary items: ${i.itinerary?.days?.length||0} days`,l.cyan);log(`  â†’ Images found: ${i.images?.length||0}`,l.cyan);log(`  â†’ Price: $${(i.price/100).toFixed(2)}`,l.cyan);const g=a?"/tmp":process.cwd();const u=o.join(g,"output");if(!n.existsSync(u)){n.mkdirSync(u,{recursive:true});log(`  âœ“ Created output directory: ${u}`,l.green)}const d=o.join(u,"raw-itinerary.json");n.writeFileSync(d,JSON.stringify(i,null,2));log(`  âœ“ Output written to: ${d}`,l.green);log("\n"+"=".repeat(60),l.bright);log("  âœ“ Scraping completed successfully",l.green);log("=".repeat(60)+"\n",l.bright)}catch(e){log(`\nâœ— Scraping failed: ${e.message}`,l.red);throw e}finally{await p.close();log("  âœ“ Browser closed",l.green)}}function mergeItineraryData(e,r,t){let a=0;if(e&&Array.isArray(e)){const r=e.find((e=>e.id===parseInt(t.itineraryId)||e.itineraryId===parseInt(t.itineraryId)));if(r&&r.price){a=typeof r.price==="number"?r.price:parseInt(r.price)||0}else if(r&&r.totalPrice){a=typeof r.totalPrice==="number"?r.totalPrice:parseInt(r.totalPrice)||0}}let s={};let i=[];if(r){s=r;i=extractS3Keys(r)}return{itinerary:s,images:i,price:a}}function extractS3Keys(e,r=[]){if(!e||typeof e!=="object"){return r}if(Array.isArray(e)){e.forEach((e=>extractS3Keys(e,r)))}else{Object.keys(e).forEach((t=>{if(t==="s3Key"&&typeof e[t]==="string"){r.push(e[t])}else if(typeof e[t]==="object"){extractS3Keys(e[t],r)}}))}return r}if(t.c[t.s]===e){const e=process.argv.slice(2);if(e.length===0){log("\nâœ— Error: No URL provided",l.red);log("\nUsage: node scrapers/itrvl_scraper.cjs <ITRVL_URL>",l.yellow);log("\nExample:",l.yellow);log('  node scrapers/itrvl_scraper.cjs "https://portal.itrvl.com/share?accessKey=ABC123&itineraryId=12345"\n',l.cyan);process.exit(1)}const r=e[0];scrapeItrvl(r).then((()=>{process.exit(0)})).catch((e=>{log(`\nâœ— Fatal error: ${e.message}`,l.red);if(e.stack){log(`\nStack trace:\n${e.stack}`,l.red)}process.exit(1)}))}e.exports={scrapeItrvl:scrapeItrvl,parseItrvlUrl:parseItrvlUrl}}};var r={};function __nccwpck_require__(t){var a=r[t];if(a!==undefined){return a.exports}var s=r[t]={id:t,loaded:false,exports:{}};var i=true;try{e[t](s,s.exports,__nccwpck_require__);i=false}finally{if(i)delete r[t]}s.loaded=true;return s.exports}__nccwpck_require__.c=r;(()=>{__nccwpck_require__.nmd=e=>{e.paths=[];if(!e.children)e.children=[];return e}})();if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var t=__nccwpck_require__(__nccwpck_require__.s=127);module.exports=t})();