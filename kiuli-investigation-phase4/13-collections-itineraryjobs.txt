=== ITINERARY JOBS COLLECTION ===

--- Main file ---
import type { CollectionConfig } from 'payload'
import { authenticated } from '../../access/authenticated'

export const ItineraryJobs: CollectionConfig<'itinerary-jobs'> = {
  slug: 'itinerary-jobs',
  access: {
    create: authenticated,
    delete: authenticated,
    read: authenticated,
    update: authenticated,
  },
  admin: {
    defaultColumns: ['itrvlUrl', 'status', 'itineraryId', 'duration', 'createdAt'],
    useAsTitle: 'itrvlUrl',
    description: 'Manage iTrvl itinerary processing jobs. Paste an iTrvl URL to create a job, then use the "Trigger Processing" button to start the pipeline.',
    listSearchableFields: ['itrvlUrl', 'itineraryId', 'payloadId'],
  },
  fields: [
    {
      name: 'itrvlUrl',
      type: 'text',
      required: true,
      label: 'iTrvl URL',
      admin: {
        description: 'Paste the full iTrvl client portal URL (e.g., https://itrvl.com/client/portal/{accessKey}/{itineraryId})',
        placeholder: 'https://itrvl.com/client/portal/...',
      },
    },
    {
      name: 'itineraryId',
      type: 'text',
      required: false,
      label: 'Itinerary ID',
      admin: {
        description: 'Unique iTrvl itinerary identifier (auto-extracted from URL)',
        readOnly: true,
      },
    },
    {
      name: 'accessKey',
      type: 'text',
      required: false,
      label: 'Access Key',
      admin: {
        description: 'iTrvl access key (auto-extracted from URL)',
        readOnly: true,
      },
    },
    {
      type: 'tabs',
      tabs: [
        {
          label: 'Status',
          fields: [
            {
              name: 'processButton',
              type: 'ui',
              admin: {
                components: {
                  Field: './components/ProcessButton#ProcessButton',
                },
              },
            },
            {
              name: 'status',
              type: 'select',
              required: true,
              defaultValue: 'pending',
              options: [
                {
                  label: 'Pending',
                  value: 'pending',
                },
                {
                  label: 'Processing',
                  value: 'processing',
                },
                {
                  label: 'Completed',
                  value: 'completed',
                },
                {
                  label: 'Failed',
                  value: 'failed',
                },
              ],
              label: 'Processing Status',
              admin: {
                description: 'Current status of the itinerary processing job',
              },
            },
            {
              name: 'currentPhase',
              type: 'text',
              label: 'Current Phase',
              admin: {
                description: 'Current pipeline phase (e.g., "Phase 2: Scraping", "Phase 3: Media Rehosting")',
                readOnly: true,
              },
            },
            {
              name: 'progressLog',
              type: 'textarea',
              label: 'Progress Log',
              admin: {
                description: 'Real-time processing logs and progress updates',
                readOnly: true,
              },
            },
            {
              name: 'errorMessage',
              type: 'textarea',
              label: 'Error Message',
              admin: {
                description: 'Error details if processing failed',
                readOnly: true,
              },
            },
          ],
        },
        {
          label: 'Results',
          fields: [
            {
              name: 'processedItinerary',
              type: 'relationship',
              relationTo: 'itineraries',
              hasMany: false,
              label: 'Processed Itinerary',
              admin: {
                description: 'The final Payload itinerary created from this job',
              },
            },
            {
              name: 'relatedArticles',
              type: 'relationship',
              relationTo: 'posts',
              hasMany: true,
              label: 'Related Articles',
              admin: {
                description: 'AI-generated articles and content related to this itinerary',
              },
            },
            {
              name: 'payloadId',
              type: 'text',
              label: 'Payload Entry ID',
              admin: {
                description: 'The Payload CMS entry ID created during ingestion (Phase 7)',
                readOnly: true,
              },
            },
          ],
        },
        {
          label: 'Metrics',
          fields: [
            {
              name: 'startedAt',
              type: 'date',
              label: 'Processing Started',
              admin: {
                date: {
                  pickerAppearance: 'dayAndTime',
                },
                description: 'Timestamp when processing started',
                readOnly: true,
              },
            },
            {
              name: 'completedAt',
              type: 'date',
              label: 'Processing Completed',
              admin: {
                date: {
                  pickerAppearance: 'dayAndTime',
                },
                description: 'Timestamp when processing completed or failed',
                readOnly: true,
              },
            },
            {
              name: 'duration',
              type: 'number',
              label: 'Duration (seconds)',
              admin: {
                description: 'Total processing time in seconds',
                readOnly: true,
              },
            },
            {
              name: 'timings',
              type: 'json',
              label: 'Phase Timings',
              admin: {
                description: 'Breakdown of time spent in each pipeline phase',
                readOnly: true,
              },
            },
          ],
        },
      ],
    },
  ],
  hooks: {
    beforeChange: [
      ({ data, operation }) => {
        // Auto-extract itineraryId and accessKey from URL on create
        if (operation === 'create' && data.itrvlUrl) {
          try {
            const url = new URL(data.itrvlUrl)
            const pathParts = url.pathname.split('/').filter(part => part.length > 0)
            const portalIndex = pathParts.indexOf('portal')

            if (portalIndex !== -1 && pathParts.length >= portalIndex + 3) {
              data.accessKey = pathParts[portalIndex + 1]
              data.itineraryId = pathParts[portalIndex + 2]
            }
          } catch (error) {
            // URL parsing failed, leave fields empty
            console.error('Failed to parse iTrvl URL:', error)
          }
        }

        return data
      },
    ],
  },
  timestamps: true,
}

--- All files in ItineraryJobs/ ---
=== src/collections/ItineraryJobs/components/ProcessButton.tsx ===
'use client'

import React, { useState } from 'react'
import { Button, useDocumentInfo, useForm } from '@payloadcms/ui'

export const ProcessButton: React.FC = () => {
  const { docID } = useDocumentInfo()
  const { getData, getDataByPath } = useForm()
  const [isProcessing, setIsProcessing] = useState(false)
  const [message, setMessage] = useState('')

  const handleProcess = async () => {
    try {
      setIsProcessing(true)
      setMessage('')

      // Get the current form data
      const formData = getData()
      const itrvlUrl = getDataByPath('itrvlUrl')

      if (!itrvlUrl) {
        setMessage('Error: iTrvl URL is required')
        return
      }

      // Call the processing API
      const response = await fetch('/api/scrape-itinerary', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ itrvlUrl }),
      })

      const result = await response.json()

      if (response.ok) {
        if (result.success) {
          setMessage(
            `Success! Processing completed in ${result.duration}s. Payload ID: ${result.payloadId}`,
          )
        } else {
          setMessage(`Warning: Processing completed with errors. ${result.error || ''}`)
        }
      } else {
        setMessage(`Error: ${result.error || 'Failed to trigger processing'}`)
      }
    } catch (error: any) {
      setMessage(`Error: ${error.message || 'Failed to trigger processing'}`)
    } finally {
      setIsProcessing(false)
    }
  }

  return (
    <div style={{ marginTop: '1rem' }}>
      <Button
        buttonStyle="primary"
        onClick={handleProcess}
        disabled={isProcessing}
        style={{ marginBottom: '0.5rem' }}
      >
        {isProcessing ? 'Processing...' : 'Trigger Processing Pipeline'}
      </Button>

      {message && (
        <div
          style={{
            padding: '0.75rem',
            marginTop: '0.5rem',
            borderRadius: '4px',
            backgroundColor: message.startsWith('Success')
              ? '#d4edda'
              : message.startsWith('Warning')
                ? '#fff3cd'
                : '#f8d7da',
            color: message.startsWith('Success')
              ? '#155724'
              : message.startsWith('Warning')
                ? '#856404'
                : '#721c24',
            border: `1px solid ${message.startsWith('Success') ? '#c3e6cb' : message.startsWith('Warning') ? '#ffeeba' : '#f5c6cb'}`,
          }}
        >
          {message}
        </div>
      )}

      <div style={{ marginTop: '0.5rem', fontSize: '0.875rem', color: '#666' }}>
        This will trigger the full processing pipeline (Phases 2-7):
        <br />
        Scrape → Media Rehost → AI Enhance → Schema Gen → Validate → FAQ → Payload Ingest
      </div>
    </div>
  )
}
=== src/collections/ItineraryJobs/components/StatusBadge.tsx ===
'use client'

import React from 'react'

interface StatusBadgeProps {
  status: 'pending' | 'processing' | 'completed' | 'failed'
}

export const StatusBadge: React.FC<StatusBadgeProps> = ({ status }) => {
  const styles: Record<typeof status, { bg: string; text: string; border: string }> = {
    pending: {
      bg: '#f0f0f0',
      text: '#666',
      border: '#d0d0d0',
    },
    processing: {
      bg: '#e3f2fd',
      text: '#1976d2',
      border: '#90caf9',
    },
    completed: {
      bg: '#d4edda',
      text: '#155724',
      border: '#c3e6cb',
    },
    failed: {
      bg: '#f8d7da',
      text: '#721c24',
      border: '#f5c6cb',
    },
  }

  const labels: Record<typeof status, string> = {
    pending: 'Pending',
    processing: 'Processing',
    completed: 'Completed',
    failed: 'Failed',
  }

  const style = styles[status] || styles.pending

  return (
    <span
      style={{
        display: 'inline-block',
        padding: '0.25rem 0.75rem',
        borderRadius: '12px',
        fontSize: '0.875rem',
        fontWeight: 600,
        backgroundColor: style.bg,
        color: style.text,
        border: `1px solid ${style.border}`,
        textTransform: 'uppercase',
        letterSpacing: '0.5px',
      }}
    >
      {labels[status]}
    </span>
  )
}
=== src/collections/ItineraryJobs/index.ts ===
import type { CollectionConfig } from 'payload'
import { authenticated } from '../../access/authenticated'

export const ItineraryJobs: CollectionConfig<'itinerary-jobs'> = {
  slug: 'itinerary-jobs',
  access: {
    create: authenticated,
    delete: authenticated,
    read: authenticated,
    update: authenticated,
  },
  admin: {
    defaultColumns: ['itrvlUrl', 'status', 'itineraryId', 'duration', 'createdAt'],
    useAsTitle: 'itrvlUrl',
    description: 'Manage iTrvl itinerary processing jobs. Paste an iTrvl URL to create a job, then use the "Trigger Processing" button to start the pipeline.',
    listSearchableFields: ['itrvlUrl', 'itineraryId', 'payloadId'],
  },
  fields: [
    {
      name: 'itrvlUrl',
      type: 'text',
      required: true,
      label: 'iTrvl URL',
      admin: {
        description: 'Paste the full iTrvl client portal URL (e.g., https://itrvl.com/client/portal/{accessKey}/{itineraryId})',
        placeholder: 'https://itrvl.com/client/portal/...',
      },
    },
    {
      name: 'itineraryId',
      type: 'text',
      required: false,
      label: 'Itinerary ID',
      admin: {
        description: 'Unique iTrvl itinerary identifier (auto-extracted from URL)',
        readOnly: true,
      },
    },
    {
      name: 'accessKey',
      type: 'text',
      required: false,
      label: 'Access Key',
      admin: {
        description: 'iTrvl access key (auto-extracted from URL)',
        readOnly: true,
      },
    },
    {
      type: 'tabs',
      tabs: [
        {
          label: 'Status',
          fields: [
            {
              name: 'processButton',
              type: 'ui',
              admin: {
                components: {
                  Field: './components/ProcessButton#ProcessButton',
                },
              },
            },
            {
              name: 'status',
              type: 'select',
              required: true,
              defaultValue: 'pending',
              options: [
                {
                  label: 'Pending',
                  value: 'pending',
                },
                {
                  label: 'Processing',
                  value: 'processing',
                },
                {
                  label: 'Completed',
                  value: 'completed',
                },
                {
                  label: 'Failed',
                  value: 'failed',
                },
              ],
              label: 'Processing Status',
              admin: {
                description: 'Current status of the itinerary processing job',
              },
            },
            {
              name: 'currentPhase',
              type: 'text',
              label: 'Current Phase',
              admin: {
                description: 'Current pipeline phase (e.g., "Phase 2: Scraping", "Phase 3: Media Rehosting")',
                readOnly: true,
              },
            },
            {
              name: 'progressLog',
              type: 'textarea',
              label: 'Progress Log',
              admin: {
                description: 'Real-time processing logs and progress updates',
                readOnly: true,
              },
            },
            {
              name: 'errorMessage',
              type: 'textarea',
              label: 'Error Message',
              admin: {
                description: 'Error details if processing failed',
                readOnly: true,
              },
            },
          ],
        },
        {
          label: 'Results',
          fields: [
            {
              name: 'processedItinerary',
              type: 'relationship',
              relationTo: 'itineraries',
              hasMany: false,
              label: 'Processed Itinerary',
              admin: {
                description: 'The final Payload itinerary created from this job',
              },
            },
            {
              name: 'relatedArticles',
              type: 'relationship',
              relationTo: 'posts',
              hasMany: true,
              label: 'Related Articles',
              admin: {
                description: 'AI-generated articles and content related to this itinerary',
              },
            },
            {
              name: 'payloadId',
              type: 'text',
              label: 'Payload Entry ID',
              admin: {
                description: 'The Payload CMS entry ID created during ingestion (Phase 7)',
                readOnly: true,
              },
            },
          ],
        },
        {
          label: 'Metrics',
          fields: [
            {
              name: 'startedAt',
              type: 'date',
              label: 'Processing Started',
              admin: {
                date: {
                  pickerAppearance: 'dayAndTime',
                },
                description: 'Timestamp when processing started',
                readOnly: true,
              },
            },
            {
              name: 'completedAt',
              type: 'date',
              label: 'Processing Completed',
              admin: {
                date: {
                  pickerAppearance: 'dayAndTime',
                },
                description: 'Timestamp when processing completed or failed',
                readOnly: true,
              },
            },
            {
              name: 'duration',
              type: 'number',
              label: 'Duration (seconds)',
              admin: {
                description: 'Total processing time in seconds',
                readOnly: true,
              },
            },
            {
              name: 'timings',
              type: 'json',
              label: 'Phase Timings',
              admin: {
                description: 'Breakdown of time spent in each pipeline phase',
                readOnly: true,
              },
            },
          ],
        },
      ],
    },
  ],
  hooks: {
    beforeChange: [
      ({ data, operation }) => {
        // Auto-extract itineraryId and accessKey from URL on create
        if (operation === 'create' && data.itrvlUrl) {
          try {
            const url = new URL(data.itrvlUrl)
            const pathParts = url.pathname.split('/').filter(part => part.length > 0)
            const portalIndex = pathParts.indexOf('portal')

            if (portalIndex !== -1 && pathParts.length >= portalIndex + 3) {
              data.accessKey = pathParts[portalIndex + 1]
              data.itineraryId = pathParts[portalIndex + 2]
            }
          } catch (error) {
            // URL parsing failed, leave fields empty
            console.error('Failed to parse iTrvl URL:', error)
          }
        }

        return data
      },
    ],
  },
  timestamps: true,
}
