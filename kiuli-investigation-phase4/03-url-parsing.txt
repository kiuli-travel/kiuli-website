=== URL PARSING FUNCTIONS ===

--- Search for parseItrvlUrl ---
./pipelines/run_full_pipeline.cjs:25:const { parseItrvlUrl } = require('../scrapers/itrvl_scraper.cjs');
./pipelines/run_full_pipeline.cjs:192:  const { itineraryId } = parseItrvlUrl(itrvlUrl);
./scrapers/itrvl_scraper.cjs:48:function parseItrvlUrl(url) {
./scrapers/itrvl_scraper.cjs:101:    parsedUrl = parseItrvlUrl(url);
./scrapers/itrvl_scraper.cjs:357:module.exports = { scrapeItrvl, parseItrvlUrl };
./src/app/(payload)/api/scrape-itinerary/route.ts:52:    const { parseItrvlUrl } = await import(
./src/app/(payload)/api/scrape-itinerary/route.ts:55:    const { itineraryId } = parseItrvlUrl(itrvlUrl)

--- Full parseItrvlUrl implementation from scraper ---
function log(message, color = colors.reset) {
  console.log(`${color}${message}${colors.reset}`);
}

// Parse iTrvl URL to extract Access Key and Itinerary ID
function parseItrvlUrl(url) {
  try {
    const urlObj = new URL(url);

    let accessKey = null;
    let itineraryId = null;

    // Try to extract from query parameters first
    // Format: https://portal.itrvl.com/share?accessKey=ABC&itineraryId=123
    accessKey = urlObj.searchParams.get('accessKey');
    itineraryId = urlObj.searchParams.get('itineraryId');

    // If not found in query params, try path-based format
    // Format: https://itrvl.com/client/portal/{accessKey}/{itineraryId}
    if (!accessKey || !itineraryId) {
      const pathParts = urlObj.pathname.split('/').filter(part => part.length > 0);

      // Look for /portal/{accessKey}/{itineraryId} pattern
      const portalIndex = pathParts.indexOf('portal');
      if (portalIndex !== -1 && pathParts.length >= portalIndex + 3) {
        accessKey = pathParts[portalIndex + 1];
        itineraryId = pathParts[portalIndex + 2];
      }
    }

    if (!accessKey) {
      throw new Error('accessKey not found in URL (tried query params and path)');
    }

    if (!itineraryId) {
      throw new Error('itineraryId not found in URL (tried query params and path)');
    }

    return {
      accessKey,
      itineraryId,
      baseUrl: `${urlObj.protocol}//${urlObj.host}`,
    };
  } catch (error) {
    throw new Error(`Failed to parse iTrvl URL: ${error.message}`);
  }
}

// Main scraper function
async function scrapeItrvl(url) {
  log('\n' + '='.repeat(60), colors.bright);
  log('  iTrvl API Scraper - Phase 2', colors.bright);
  log('='.repeat(60), colors.bright);

  // Parse URL
  log('\n[1/5] Parsing iTrvl URL...', colors.blue);
